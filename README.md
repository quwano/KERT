# KERT - EPUB3 & DAISY4 Support Tool

**English** | **[日本語](./README_ja.md)**

![version](https://img.shields.io/github/v/release/quwano/KERT?label=version&color=brightgreen)
![license](https://img.shields.io/badge/license-GPL-green)
![platform](https://img.shields.io/badge/platform-MacOS%20Sequoia%2FTahoe%20Windows%2011-blue)

## About This Project

KERT is a tool that generates **DAISY4/EPUB3 ebooks with Media Overlay (audio synchronization)** from text files. It is written in Python.

It supports **extended CommonMark notation** (`.txt` / `.md`) and **XML format** (`.xml`) as input formats.

### Processing Flow

```
Input file (.txt / .md / .xml)
    |  Text parsing & reading text generation
    |  TTS (text-to-speech) generates WAV
    |  FFmpeg converts to MP3
    |  Montreal Forced Aligner performs audio alignment (TextGrid generation)
    |  XHTML + SMIL generation & EPUB packaging
EPUB3 file (with audio synchronization)
```

## Requirements

### Python

Python 3.12 or later is required (due to the use of `X | None` type hint syntax).

### Conda / Montreal Forced Aligner (MFA)

[Montreal Forced Aligner (MFA)](https://montreal-forced-aligner.readthedocs.io/) is used for audio-text alignment (analyzing which words correspond to which positions in the audio).

#### Installing Conda

Conda is required as the runtime environment for MFA. Install [Miniforge](https://github.com/conda-forge/miniforge) or [Miniconda](https://docs.anaconda.com/free/miniconda/).

> **Note for Windows**: KERT automatically detects the conda executable (searching PATH, the `CONDA_EXE` environment variable, and common installation paths such as `%USERPROFILE%\miniforge3`). If automatic detection fails, add the Conda `Scripts` directory to your system PATH, or set the `CONDA_EXE` environment variable to the full path of conda.exe.

#### Installing MFA

MFA is installed in a Conda environment. The default environment name is `mfa`.

```bash
# Create Conda environment and install MFA
conda create -n mfa -c conda-forge montreal-forced-aligner
conda activate mfa
```

After installing MFA, download the dictionary and acoustic models for the languages you plan to use (see "[Installing MFA Models](#installing-mfa-models)" for details).

> **Note**: During KERT execution, MFA is automatically invoked via `conda run -n mfa`, so you do not need to run `conda activate mfa` beforehand.

#### Additional Setup for Japanese

The Japanese MFA model (`japanese_mfa`) internally uses spacy / sudachipy. After installing MFA, install the additional packages with the following commands:

```bash
conda activate mfa
pip install spacy sudachipy sudachidict_core
```

### VOICEVOX (Japanese Language Only)

[VOICEVOX](https://voicevox.hiroshiba.jp/) is used for Japanese text-to-speech synthesis.

- Start the VOICEVOX engine before running KERT.
- The default connection URL is `http://localhost:50021`.
- The default speaker is ID 109 (Tohoku Itako).

VOICEVOX is not required if you only use English or German.

> **Important: VOICEVOX Terms of Use**
>
> When distributing or publishing EPUBs containing audio generated by VOICEVOX, you must review the VOICEVOX [Terms of Use](https://voicevox.hiroshiba.jp/term/) and the individual character terms of use. Some characters have restrictions on commercial use or require credit attribution. The default speaker in KERT is "Tohoku Itako" (ID 109). For details on the terms of use, see the [Tohoku Itako official site](https://voicevox.hiroshiba.jp/product/tohoku_itako/).

### macOS say / Windows SAPI (English & German)

Built-in OS TTS is used for English and German text-to-speech synthesis.

- **macOS**: `say` command (English: Samantha, German: Anna)
- **Windows**: Uses System.Speech.Synthesis (SAPI) via PowerShell. Automatically falls back from macOS say with the same language settings.

> **Note for Windows**: The language pack for the target language must be installed in advance. Go to **Windows Settings > Time & Language > Language**, add English or German, and make sure **Speech** is enabled.

### FFmpeg

[FFmpeg](https://ffmpeg.org/) is used to convert WAV files generated by TTS to MP3.

```bash
# macOS (Homebrew)
brew install ffmpeg

# Windows (Chocolatey)
choco install ffmpeg
```

Ensure the `ffmpeg` command is available in your PATH.

### pip Packages

```bash
pip install -r requirements.txt
```

Installed packages:

| Package | Purpose |
|---------|---------|
| `textgrid` | Reading TextGrid files generated by MFA |
| `saxonche` | XSLT 3.0 processor |

saxonche is used for XML input conversion. It is not required if you only use CommonMark input. If not needed, remove the saxonche entry from requirements.txt.

## Multi-Language Support

### Supported Languages

| Language Code | Language | TTS Engine | MFA Dictionary / Acoustic Model |
|---------------|----------|------------|--------------------------------|
| `ja_JP` | Japanese | VOICEVOX | `japanese_mfa` |
| `en_US` | English (US) | macOS say (Samantha) / Windows SAPI | `english_us_arpa` |
| `de_DE` | Deutsch | macOS say (Anna) / Windows SAPI | `german_mfa` |

### Installing MFA Models

Download the dictionary and acoustic models for the languages you plan to use.

```bash
# Japanese
conda run -n mfa mfa model download dictionary japanese_mfa
conda run -n mfa mfa model download acoustic japanese_mfa

# English (US)
conda run -n mfa mfa model download dictionary english_us_arpa
conda run -n mfa mfa model download acoustic english_us_arpa

# German
conda run -n mfa mfa model download dictionary german_mfa
conda run -n mfa mfa model download acoustic german_mfa
```

### Adding New Languages

Languages beyond the three listed above can be supported. To add a language, follow these steps:

1. **Prepare MFA models**: Install the dictionary and acoustic models for the target language. See the [MFA documentation](https://mfa-models.readthedocs.io/) for available models.

2. **Add an entry to `LANGUAGE_CONFIGS` in `core/config.py`**: Use the following format:

```python
"fr_FR": LanguageConfig(
    code="fr_FR",
    display_name="Fran\u00e7ais",
    epub_lang="fr",
    mfa_dictionary="french_mfa",      # MFA dictionary model name
    mfa_acoustic="french_mfa",        # MFA acoustic model name
    tts_engine="say",                  # "voicevox" or "say"
    tts_voice="Thomas",               # macOS say voice name (when using say)
),
```

- `tts_engine`: Use `"voicevox"` for Japanese, `"say"` for other languages. On Windows, specifying `"say"` automatically falls back to SAPI.
- `tts_voice`: The voice name for macOS say. Run `say -v '?'` to list available voices.

## Creating Documents

KERT supports two input formats: **extended CommonMark notation** and **XML format**.

### Extended CommonMark Notation

Write in CommonMark (Markdown)-based notation in text files with `.txt` or `.md` extensions.

#### Heading Hierarchy

Use `#` (1 to 5) to write headings. Each heading is split into a separate page (XHTML file) within the EPUB, and the hierarchical structure is reflected in the table of contents (nav.xhtml).

```markdown
# Book Title

First paragraph.

## Chapter 1

Chapter 1 content.

### Section 1

Section 1 content.
```

- `#` becomes the book title (h1).
- `##` and beyond are structured as chapters and sections.
- Files without headings can also be processed (in which case, the title from metadata.txt is used).

#### Formatting Notation

| Notation | Description | Example | EPUB Display |
|----------|-------------|---------|-------------|
| `[kanji](-furigana)` | Ruby (furigana) | `[kanji](-reading)` | Ruby annotation above text |
| `[display text](+reading)` | Alternative reading | `[display](+read)` | Shows "display", reads aloud "read" |
| `**text**` | Bold | `**important**` | **important** |
| `[text]{.underline}` | Underline | `[note]{.underline}` | <u>note</u> |
| `[text]{.frame}` | Framed box | `[A]{.frame}` | Text with border |
| `~text~` | Subscript | `H~2~O` | H<sub>2</sub>O |
| `^text^` | Superscript | `10^3^` | 10<sup>3</sup> |

- The alternative reading notation `[display](+reading)` is used when you want different display text and spoken text.
- Formatting notations support nesting. Example: `[**bold underline**]{.underline}`

#### Inserting Images

```markdown
![alt text](image_file_path)
```

- Place image files in the same directory as the input file, or specify a relative path.
- Images are copied to the `images/` directory within the EPUB.
- Supported formats: SVG, PNG, JPEG, GIF, WebP

### XML Format

Write XML files conforming to the XML schema (`resources/document_schema.xsd`).

#### Basic Structure

```xml
<?xml version="1.0" encoding="UTF-8"?>
<root>
  <title1>Book Title</title1>
  <p>A paragraph of body text.</p>
  <p>The next paragraph.</p>
</root>
```

The root element is `<root>`, with heading elements (`title1` to `title5`) and paragraph elements (`p`) placed directly under it.

#### Element List

| Element | Description | Example |
|---------|-------------|---------|
| `<p>` | Paragraph | `<p>Body text</p>` |
| `<title1>` to `<title5>` | Heading (level 1-5) | `<title1>Title</title1>` |
| `<ruby yomi="reading">base text</ruby>` | Ruby | `<ruby yomi="reading">kanji</ruby>` |
| `<yomikae yomi="reading">display</yomikae>` | Alternative reading | `<yomikae yomi="read">display</yomikae>` |
| `<u>` | Underline | `<u>underlined text</u>` |
| `<g>` | Emphasis (bold) | `<g>emphasized text</g>` |
| `<sub>` | Subscript | `<sub>2</sub>` |
| `<sup>` | Superscript | `<sup>3</sup>` |

- Decoration elements can be nested. Example: `<u><g>bold underline</g></u>`

#### Heading Hierarchy (title1 to title5)

Using `title1` to `title5` splits the content into separate pages within the EPUB at each heading and generates a hierarchical table of contents. These correspond to CommonMark's `#` through `#####`.

```xml
<root>
  <title1>Book Title</title1>
  <title2>Chapter 1</title2>
  <p>Chapter 1 content.</p>
  <title3>Section 1</title3>
  <p>Section 1 content.</p>
  <title2>Chapter 2</title2>
  <p>Chapter 2 content.</p>
</root>
```

### Metadata File (metadata.txt)

A text file containing bibliographic information (title, author, etc.) for the EPUB. **The title is required.**

#### File Naming Rules

- **Single file input**: Place `{input_filename_without_extension}_metadata.txt` in the same directory as the input file.
  - Example: `mybook.txt` -> `mybook_metadata.txt`
  - Example: `document.xml` -> `document_metadata.txt`
- **Folder input**: Place `{folder_name}_metadata.txt` in the parent directory of the folder.
  - Example: folder `chapters/` -> `chapters_metadata.txt` in the parent directory

#### Format

A UTF-8 encoded text file with each line in `key: value` format.

```
title: Book Title
author: Author Name
contributor: Contributor
publisher: Publisher Name
rights: (C) 2026 Author Name
subject: Genre
```

| Key | Description | Required |
|-----|-------------|----------|
| `title` | Book title | Required |
| `author` | Author name | |
| `contributor` | Contributor | |
| `publisher` | Publisher name | |
| `rights` | Rights statement | |
| `subject` | Genre / category | |

#### Accessibility Metadata

You can add EPUB accessibility information.
```
accessMode: textual
accessModeSufficient: textual
accessibilityFeature: index
accessibilityHazard: noFlashingHazard
accessibilityHazard: noMotionSimulationHazard
accessibilityHazard: noSoundHazard
accessibilitySummary: No special notes
```

For details, see the [DAISY website](https://kb.daisy.org/publishing/docs/metadata/schema.org/index.html).

### Single File and Folder (Multiple Files)

KERT supports two processing modes.

**Single file mode**: Generates one EPUB from a single input file. Audio is combined into a single file.

**Folder mode**: Combines multiple files in a folder into one EPUB. Each file becomes one chapter, with individual audio files generated per file.

```
chapters/
+-- 01_prologue.txt    -> chapter1.xhtml + chapter1.mp3
+-- 02_chapter1.txt    -> chapter2.xhtml + chapter2.mp3
+-- 03_chapter2.txt    -> chapter3.xhtml + chapter3.mp3
```

- Files are sorted in natural order by filename (numeric parts are compared as numbers).
- For CommonMark, both `.txt` and `.md` files are collected.
- For XML, `.xml` files are collected.
- Place the `_metadata.txt` for folders in the parent directory.

## Usage

### Running

```bash
python main.py
```

You will be prompted interactively to select the following:

1. **Language**: Japanese / English (US) / Deutsch
2. **Input format**: CommonMark extended text file / XML file
3. **Processing mode**: Single file / Folder (multiple files)
4. **Input path**: File or folder path
5. **Intermediate files**: Whether to keep them

### Example Run

For Japanese, CommonMark, single file:

```
$ python main.py
==================================================
EPUB Generator
==================================================
Select language:
  1: Japanese (ja_JP)
  2: English (US) (en_US)
  3: Deutsch (de_DE)
------
Language (1-3, default: 1): 1
------
Select input format:
  1: CommonMark extended text file (.txt/.md)
  2: XML file (.xml)
------
Selection (1-2, default: 1): 1
------
Select processing mode:
  1: Generate EPUB from a single CommonMark extended file
  2: Generate EPUB from multiple CommonMark extended files in a folder
------
Selection (1-2, default: 1): 1
------
Specify the path to the CommonMark extended file (.txt/.md)
/path/to/mybook.txt
------
Keep intermediate files (META-INF, OEBPS, audio.*)?
  1: Do not keep (default)
  2: Keep
------
Selection (1-2, default: 1): 1
```

### Output Files

The generated EPUB file is output to the same directory as the input file.

Filename format: `{input_filename}_{mode_number}_{timestamp}.epub`

- Mode number: A concatenation of the selected language, format, and processing mode numbers (e.g., `111`)
- Timestamp: `YYYYMMDDHHmmss` format

Example: `mybook_111_20250219143000.epub`

### Intermediate Files

If you select "Keep intermediate files", the following are saved in the `intermediate_products/` directory.

**Single file mode**:

| File | Content |
|------|---------|
| `audio.txt` | Reading text passed to TTS |
| `audio.wav` | WAV audio generated by TTS |
| `audio.mp3` | MP3 audio converted by FFmpeg |
| `audio.TextGrid` | Alignment information generated by MFA |
| `META-INF/` | EPUB container information |
| `OEBPS/` | EPUB content (XHTML, SMIL, CSS, etc.) |

**Folder mode**:

| File | Content |
|------|---------|
| `work_multi/audio/` | MP3 audio for each chapter |
| `work_multi/textgrid/` | TextGrid for each chapter |
| `META-INF/` | EPUB container information |
| `OEBPS/` | EPUB content |

You can debug formatting conversion results and span splitting by inspecting the intermediate XHTML files.

## Generated EPUB Structure

The internal structure of the generated EPUB3 is as follows.

**Single file input (with headings)**:

```
book.epub
+-- mimetype
+-- META-INF/
|   +-- container.xml
+-- OEBPS/
    +-- content.opf          <- Package document
    +-- text/
    |   +-- nav.xhtml        <- Hierarchical table of contents
    |   +-- chapter1.xhtml   <- # Heading 1
    |   +-- chapter2.xhtml   <- ## Heading 2
    |   +-- ...
    +-- smil/
    |   +-- chapter1.smil    <- Audio synchronization info
    |   +-- chapter2.smil
    |   +-- ...
    +-- audio/
    |   +-- audio.mp3        <- Single audio file
    +-- styles/
        +-- style.css        <- CSS for highlight display
```

**Folder input**:

```
book.epub
+-- mimetype
+-- META-INF/
|   +-- container.xml
+-- OEBPS/
    +-- content.opf
    +-- text/
    |   +-- nav.xhtml
    |   +-- chapter1.xhtml   <- File 1
    |   +-- chapter2.xhtml   <- File 2
    |   +-- ...
    +-- smil/
    |   +-- chapter1.smil
    |   +-- chapter2.smil
    |   +-- ...
    +-- audio/
    |   +-- chapter1.mp3     <- Audio for file 1
    |   +-- chapter2.mp3     <- Audio for file 2
    |   +-- ...
    +-- styles/
        +-- style.css
```

During playback, highlighted text is displayed with a yellow background using the CSS class `.-epub-media-overlay-active`.

To change the highlight color, edit the `background-color` and `color` values in `CSS_CONTENT` in `epub/packaging.py`.

### Tested Environments

The EPUB3 files generated by this tool have been tested in the following environments:

- **Display & Media Overlay playback**: [Thorium Reader](https://thorium.edrlab.org/)
- **EPUB3 compliance check**: [Ace by DAISY](https://daisy.github.io/ace/)

## Included Tools

The `tools/` directory contains standalone tools for preparing input files.

### split_commonmark — CommonMark File Splitter

Splits a long CommonMark file into multiple files by heading. Useful as a preprocessing step for folder mode processing.

```bash
python tools/split_commonmark.py
```

- Sections starting with `#` (h1) are output to `{original_filename}_0{extension}`
- Sections starting with `##` (h2) are output to `{original_filename}_1{extension}`, `{original_filename}_2{extension}`, ...

### unwrap_lines — Line Joiner

Replaces line breaks within paragraphs with spaces. Useful for preprocessing files where paragraphs are broken across lines, such as English text.

```bash
python tools/unwrap_lines.py
```

- Recognizes blank lines as paragraph separators and converts line breaks within paragraphs to spaces.
- The output file has `_` appended to the original filename (e.g., `input.txt` -> `input_.txt`).

## Acknowledgments

I sincerely thank the following person for their testing and valuable feedback during the development of this tool:

**Tsubasa Miyazaki** - Manual review and Windows testing

## Author
Kazuyuki Kuwano

## License and Rights Information

See [LICENSE.md](LICENSE.md).
